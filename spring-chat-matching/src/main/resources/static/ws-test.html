<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>WebSocket STOMP í†µí•© í…ŒìŠ¤íŠ¸</title>

    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial; padding: 20px; }
        .client-box {
            border: 2px solid #888;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
        }
        .title-user { color: #007bff; }
        .title-counselor { color: #d9534f; }
        input, button, textarea { margin: 6px; padding: 8px; }
        textarea { width: 380px; height: 120px; }
        .log {
            width: 100%; height: 200px; border: 1px solid #ccc;
            padding: 8px; overflow:auto; white-space:pre-wrap;
            background: #fafafa;
        }
    </style>
</head>

<body>

<h1>ğŸ”µ WebSocket STOMP í†µí•© í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h1>
<hr/>

<!-- ================================================================
     USER CLIENT
================================================================ -->
<div class="client-box">
    <h2 class="title-user">ğŸŸ¦ USER</h2>

    <label>USER Access Token</label><br/>
    <input type="text" id="userToken" style="width: 500px;"><br/>

    <button onclick="connectWS('user')">CONNECT</button>
    <button onclick="disconnectWS('user')">DISCONNECT</button>

    <h4>SUBSCRIBE</h4>
    <input type="text" id="userSub" placeholder="/sub/session/16" disabled>
    <button onclick="subscribeWS('user')" id="userSubBtn" disabled>SUBSCRIBE</button>

    <h4>SEND</h4>
    <input type="text" id="userSendDest" value="/pub/session/16" style="width: 300px;"><br/>

    <textarea id="userMsg">{
  "type": "MESSAGE",
  "sessionId": "16",
  "message": "ì•ˆë…•í•˜ì„¸ìš” (from USER)"
}</textarea>

    <br/><button onclick="sendWS('user')">SEND</button>

    <h4>ğŸ“œ USER LOG</h4>
    <div id="userLog" class="log"></div>
</div>


<!-- ================================================================
     COUNSELOR CLIENT
================================================================ -->
<div class="client-box">
    <h2 class="title-counselor">ğŸŸ¥ COUNSELOR</h2>

    <label>COUNSELOR Access Token</label><br/>
    <input type="text" id="counToken" style="width: 500px;"><br/>

    <button onclick="connectWS('coun')">CONNECT</button>
    <button onclick="disconnectWS('coun')">DISCONNECT</button>

    <h4>SUBSCRIBE</h4>
    <input type="text" id="counSub" placeholder="/sub/session/16" disabled>
    <button onclick="subscribeWS('coun')" id="counSubBtn" disabled>SUBSCRIBE</button>

    <h4>SEND</h4>
    <input type="text" id="counSendDest" value="/pub/session/16" style="width: 300px;"><br/>

    <textarea id="counMsg">{
  "type": "MESSAGE",
  "sessionId": "16",
  "message": "ì•ˆë…•í•˜ì„¸ìš” (from COUNSELOR)"
}</textarea>

    <br/><button onclick="sendWS('coun')">SEND</button>

    <h4>ğŸ“œ COUNSELOR LOG</h4>
    <div id="counLog" class="log"></div>
</div>


<script>

    // ê°ì²´ë¡œ ë¶„ë¦¬í•˜ì—¬ ê° í´ë¼ì´ì–¸íŠ¸ ë…ë¦½ ë™ì‘
    const clients = {
        user: { stomp: null, connected: false, subscribed: false },
        coun: { stomp: null, connected: false, subscribed: false }
    };

    function log(type, msg) {
        const box = document.getElementById(type + "Log");
        box.innerHTML += msg + "\n";
    }

    // ================================================================
    // CONNECT
    // ================================================================
    function connectWS(type) {

        log(type, "CONNECT ì‹œë„ì¤‘...");

        const client = clients[type];
        const token = document.getElementById(type + "Token").value;

        client.stomp = Stomp.client("ws://localhost:8080/ws/connect");
        client.stomp.reconnect_delay = 0; // ìë™ reconnect ì œê±°

        client.stomp.connect(
            { Authorization: "Bearer " + token },

            frame => {
                client.connected = true;
                log(type, "âœ” CONNECT ì„±ê³µ:\n" + frame);

                document.getElementById(type + "Sub").disabled = false;
                document.getElementById(type + "SubBtn").disabled = false;
            },

            error => log(type, "âŒ CONNECT ì—ëŸ¬:\n" + error)
        );
    }


    // ================================================================
    // SUBSCRIBE (ì¤‘ë³µ ë°©ì§€)
    // ================================================================
    function subscribeWS(type) {
        const client = clients[type];

        if (!client.connected) return log(type, "âŒ CONNECT ë¨¼ì € í•˜ì„¸ìš”");
        if (client.subscribed) return log(type, "âš  ì´ë¯¸ SUBSCRIBE ìƒíƒœ");

        const dest = document.getElementById(type + "Sub").value;

        client.stomp.subscribe(dest, msg => {
            log(type, "ğŸ“© ìˆ˜ì‹ : " + msg.body);
        });

        client.subscribed = true;
        log(type, "ğŸ”” SUBSCRIBE â†’ " + dest);
    }

    // ================================================================
    // SEND MESSAGE
    // ================================================================
    function sendWS(type) {
        const client = clients[type];

        if (!client.connected)
            return log(type, "âŒ SEND ë¶ˆê°€: CONNECT í•„ìš”");

        const dest = document.getElementById(type + "SendDest").value;
        const body = document.getElementById(type + "Msg").value;

        client.stomp.send(dest, {}, body);
        log(type, "ğŸ“¤ SEND: " + body);
    }


    // ================================================================
    // DISCONNECT
    // ================================================================
    function disconnectWS(type) {
        const client = clients[type];

        if (client.stomp) {
            client.stomp.disconnect();
            client.connected = false;
            client.subscribed = false;

            log(type, "ğŸ”Œ DISCONNECT ì™„ë£Œ");

            document.getElementById(type + "Sub").disabled = true;
            document.getElementById(type + "SubBtn").disabled = true;
        }
    }

</script>

</body>
</html>
