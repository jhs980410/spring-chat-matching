<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>COUNSELOR WebSocket Test</title>

  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { margin: 6px; padding: 8px; }
    #log { width: 100%; height: 300px; border: 1px solid #ccc;
      padding: 8px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>

<body>

<h2>ğŸŸ¥ COUNSELOR WebSocket STOMP í…ŒìŠ¤íŠ¸</h2>

<label>COUNSELOR Access Token:</label><br/>
<input type="text" id="token" style="width: 500px;"><br/>

<button onclick="connectWS()">CONNECT</button>
<button onclick="disconnectWS()">DISCONNECT</button>

<h4>SUBSCRIBE</h4>
<input type="text" id="subDest" placeholder="/sub/session/10" style="width: 300px;" disabled>
<button onclick="subscribeWS()" id="subBtn" disabled>SUBSCRIBE</button>

<h4>SEND MESSAGE</h4>
<input type="text" id="sendDest" value="/pub/session/10" style="width: 300px;"><br/>

<textarea id="msg" style="width: 300px; height: 120px;">
{
  "type": "MESSAGE",
  "sessionId": "10",
  "message": "ì•ˆë…•í•˜ì„¸ìš” (from COUNSELOR)"
}
</textarea><br/>
<button onclick="sendWS()">SEND</button>

<h3>ğŸ“œ ë¡œê·¸</h3>
<div id="log"></div>

<script>

  let stompClient = null;
  let connected = false;
  let subscribed = false;  // â­ ì¤‘ë³µ subscribe ë°©ì§€ í”Œë˜ê·¸

  function log(msg) {
    document.getElementById('log').innerHTML += msg + "\n";
  }

  function connectWS() {
    log("CONNECT ì‹œë„ì¤‘...");

    // â­ ìë™ reconnect ì œê±° â€” WebSocket ì§ì ‘ ì‚¬ìš©
    stompClient = Stomp.client("ws://localhost:8080/ws/connect");
    stompClient.reconnect_delay = 0; // â­ ìë™ ì¬ì—°ê²° ì™„ì „ ë¹„í™œì„±í™”

    const token = document.getElementById('token').value;

    stompClient.connect(
            { Authorization: "Bearer " + token },

            frame => {
              connected = true;
              log("âœ” CONNECT ì„±ê³µ:\n" + frame);

              document.getElementById('subDest').disabled = false;
              document.getElementById('subBtn').disabled = false;
            },

            error => log("âŒ CONNECT ì—ëŸ¬:\n" + error)
    );
  }

  function subscribeWS() {
    if (!connected) {
      log("âŒ ERROR: CONNECTê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }
    if (subscribed) {
      log("âš  ì´ë¯¸ SUBSCRIBE ë˜ì–´ ìˆìŒ â€” ì¤‘ë³µ ë°©ì§€");
      return;
    }

    const dest = document.getElementById('subDest').value;

    stompClient.subscribe(dest, msg => {
      log("ğŸ“© ìˆ˜ì‹ : " + msg.body);
    });

    subscribed = true;  // â­ êµ¬ë… 1íšŒë§Œ í—ˆìš©
    log("ğŸ”” SUBSCRIBE ìš”ì²­: " + dest);
  }

  function sendWS() {
    if (!connected) {
      log("âŒ SEND ë¶ˆê°€: WebSocketì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    const dest = document.getElementById('sendDest').value;
    const body = document.getElementById('msg').value;

    stompClient.send(dest, {}, body);

    log("ğŸ“¤ SEND: " + body);
  }

  function disconnectWS() {
    if (stompClient) {
      stompClient.disconnect();
      connected = false;
      subscribed = false;   // â­ ë‹¤ì‹œ êµ¬ë… ê°€ëŠ¥í•˜ë„ë¡ ì´ˆê¸°í™”

      log("ğŸ”Œ DISCONNECT ì™„ë£Œ");

      document.getElementById('subDest').disabled = true;
      document.getElementById('subBtn').disabled = true;
    }
  }

</script>
</body>
</html>
